<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Binance Order Book Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2962ff;
            --primary-dark: #1a4fd8;
            --success: #00b15d;
            --danger: #ff5b5a;
            --warning: #ffa726;
            --bg-primary: #0b0e14;
            --bg-secondary: #131722;
            --bg-tertiary: #1a1e29;
            --bg-card: #1e222d;
            --border: #2a2e39;
            --text-primary: #ffffff;
            --text-secondary: #787b86;
            --text-muted: #5d6069;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
        }

        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --bg-card: #ffffff;
            --border: #e1e4e8;
            --text-primary: #1a1e29;
            --text-secondary: #5d6069;
            --text-muted: #8a8d93;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        [data-theme="high-contrast"] {
            --bg-primary: #000000;
            --bg-secondary: #111111;
            --bg-tertiary: #222222;
            --bg-card: #333333;
            --border: #555555;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #999999;
            --shadow: 0 0 0 1px #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 100;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 16px;
        }

        .logo i {
            color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .section-title {
            padding: 12px 15px 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--bg-card);
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .header-left h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header-left .subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .price-display {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            background: var(--bg-tertiary);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 150px;
            text-align: center;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--bg-tertiary);
            transform: none;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #009950;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #e04a49;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        /* Order Panels */
        .order-panel {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title.bid {
            color: var(--success);
        }

        .panel-title.ask {
            color: var(--danger);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Order Items */
        .order-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .order-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .order-item.bid {
            background: rgba(0, 177, 93, 0.08);
            border-left-color: var(--success);
        }

        .order-item.ask {
            background: rgba(255, 91, 90, 0.08);
            border-left-color: var(--danger);
        }

        .order-item.massive {
            border-left-width: 6px;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.3);
        }

        .order-item.bid.massive {
            border-left-color: #00e676;
        }

        .order-item.ask.massive {
            border-left-color: #ff5252;
        }

        .order-info {
            flex: 1;
        }

        .order-price {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .order-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .order-volume {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 80px;
            text-align: right;
        }

        .volume-bar {
            height: 4px;
            background: linear-gradient(90deg, var(--success), var(--primary));
            border-radius: 2px;
            margin-top: 8px;
            transition: width 0.5s ease;
        }

        .order-item.ask .volume-bar {
            background: linear-gradient(90deg, var(--danger), var(--primary));
        }

        /* Info Panel */
        .info-panel {
            width: 320px;
            background: var(--bg-secondary);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .info-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .info-value {
            font-weight: 600;
            font-size: 14px;
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .setting-control {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-muted);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Heatmap */
        .heatmap-container {
            height: 120px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .heatmap-bar {
            position: absolute;
            bottom: 0;
            transition: all 0.3s ease;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.info {
            border-left-color: var(--primary);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .notification-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .content-area {
                flex-direction: column;
            }
            
            .info-panel {
                width: 100%;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Symbol List - COMPACT VERSION */
        .symbol-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .symbol-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .symbol-item:hover {
            background: var(--bg-tertiary);
        }

        .symbol-item.active {
            background: var(--primary);
            color: white;
        }

        .symbol-name {
            font-weight: 600;
            font-size: 13px;
        }

        .symbol-price {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .symbol-change {
            font-size: 12px;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        .symbol-change.positive {
            color: var(--success);
        }

        .symbol-change.negative {
            color: var(--danger);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Keyboard Shortcuts */
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .shortcut-keys {
            display: flex;
            gap: 5px;
        }

        .key {
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid var(--border);
        }

        .quick-filters {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .status {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-style: italic;
        }

        .cluster-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border-left: 4px solid var(--primary);
        }

        .cluster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .cluster-price-range {
            font-weight: 600;
            font-size: 14px;
        }

        .cluster-volume {
            font-weight: 700;
            color: var(--primary);
        }

        .cluster-orders {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .volume-info {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div class="notification" id="notification">
        <i class="fas fa-bell" id="notification-icon"></i>
        <div class="notification-content">
            <div class="notification-title" id="notification-title">Notification</div>
            <div class="notification-message" id="notification-message">This is a notification</div>
        </div>
        <button class="notification-close" onclick="hideNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-cog"></i> Settings</h2>
                <button class="modal-close" onclick="closeModal('settings-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('general-tab')">General</div>
                    <div class="tab" onclick="switchTab('appearance-tab')">Appearance</div>
                    <div class="tab" onclick="switchTab('alerts-tab')">Alerts</div>
                    <div class="tab" onclick="switchTab('shortcuts-tab')">Shortcuts</div>
                </div>

                <div class="tab-content active" id="general-tab">
                    <div class="setting-item">
                        <label class="setting-label">Auto Refresh Interval (seconds)</label>
                        <input type="number" class="setting-control" id="refresh-interval" min="5" max="60" value="10">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Order Book Depth</label>
                        <select class="setting-control" id="orderbook-depth">
                            <option value="100">100</option>
                            <option value="500" selected>500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Volume Threshold Multiplier</label>
                        <div class="slider-container">
                            <input type="range" class="setting-control" id="volume-threshold" min="1" max="10" step="0.5" value="3">
                            <span class="slider-value" id="volume-threshold-value">3.0x</span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Enable Sound Alerts</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sound-alerts">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="tab-content" id="appearance-tab">
                    <div class="setting-item">
                        <label class="setting-label">Theme</label>
                        <select class="setting-control" id="theme-selector">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                            <option value="high-contrast">High Contrast</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Show Volume Bars</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-volume-bars" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Price Format</label>
                        <select class="setting-control" id="price-format">
                            <option value="auto">Auto</option>
                            <option value="fixed2">Fixed (2 decimals)</option>
                            <option value="fixed4">Fixed (4 decimals)</option>
                            <option value="fixed6">Fixed (6 decimals)</option>
                        </select>
                    </div>
                </div>

                <div class="tab-content" id="alerts-tab">
                    <div class="setting-item">
                        <label class="setting-label">Enable Notifications</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enable-notifications" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Large Order Alert Threshold</label>
                        <input type="number" class="setting-control" id="alert-threshold" value="50000">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Notification Cooldown (minutes)</label>
                        <input type="number" class="setting-control" id="notification-cooldown" value="5" min="1" max="60">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Show Only Massive Orders (10x threshold)</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="massive-only">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Enable Desktop Notifications</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="desktop-notifications">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="tab-content" id="shortcuts-tab">
                    <div class="shortcut-item">
                        <span>Switch Symbol</span>
                        <div class="shortcut-keys">
                            <kbd class="key">Ctrl</kbd>
                            <kbd class="key">S</kbd>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Theme</span>
                        <div class="shortcut-keys">
                            <kbd class="key">Ctrl</kbd>
                            <kbd class="key">T</kbd>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span>Export Data</span>
                        <div class="shortcut-keys">
                            <kbd class="key">Ctrl</kbd>
                            <kbd class="key">E</kbd>
                        </div>
                    </div>
                    <div class="shortcut-item">
                        <span>Open Settings</span>
                        <div class="shortcut-keys">
                            <kbd class="key">Ctrl</kbd>
                            <kbd class="key">,</kbd>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn" onclick="saveSettings()"><i class="fas fa-save"></i> Save Settings</button>
                    <button class="btn btn-outline" onclick="closeModal('settings-modal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-file-export"></i> Export Data</h2>
                <button class="modal-close" onclick="closeModal('export-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <label class="setting-label">Export Format</label>
                    <select class="setting-control" id="export-format">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label class="setting-label">Include</label>
                    <select class="setting-control" id="export-include" multiple>
                        <option value="large-orders" selected>Large Orders</option>
                        <option value="orderbook" selected>Full Order Book</option>
                        <option value="market-data" selected>Market Data</option>
                        <option value="settings">Settings</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label class="setting-label">Time Range</label>
                    <select class="setting-control" id="export-range">
                        <option value="current">Current Snapshot</option>
                        <option value="1h">Last 1 Hour</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                    </select>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
                    <button class="btn btn-outline" onclick="closeModal('export-modal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>Binance Analyzer</span>
                </div>
                <button class="btn btn-outline btn-sm" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <div class="section-title">Market Overview</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-bids">0</div>
                        <div class="stat-label">Large Bids</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-asks">0</div>
                        <div class="stat-label">Large Asks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bid-ask-ratio">0.00</div>
                        <div class="stat-label">Bid/Ask Ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-volume">0</div>
                        <div class="stat-label">Total Volume</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="trend-strength">➡️ 0</div>
                        <div class="stat-label">Trend Strength</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="market-sentiment">😐</div>
                        <div class="stat-label">Market Sentiment</div>
                    </div>
                </div>

                <div class="section-title">
                    Top 30 Gainers (Futures)
                    <button class="btn btn-outline btn-sm" onclick="dashboard.loadLeaders()" title="Refresh Top Gainers">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="symbol-list" id="leaders-list">
                    <div class="loading-spinner"></div>
                </div>

                <div class="section-title">Quick Actions</div>
                <div style="padding: 0 15px;">
                    <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px;" onclick="openModal('settings-modal')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                    <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px;" onclick="openModal('export-modal')">
                        <i class="fas fa-file-export"></i> Export Data
                    </button>
                    <button class="btn btn-outline" style="width: 100%;" onclick="toggleTheme()">
                        <i class="fas fa-palette"></i> Toggle Theme
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <h1>Order Book Analysis: <span id="current-symbol">BTCUSDT</span></h1>
                    <div class="subtitle">Real-time large limit orders detection from Binance - Intraday Trading Focus</div>
                </div>
                <div class="header-right">
                    <div class="controls">
                        <select class="setting-control" id="symbol-selector" onchange="dashboard.switchSymbol(this.value)" 
                                style="min-width: 120px;">
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                            <option value="XRPUSDT">XRP/USDT</option>
                        </select>
                        <a href="#" class="btn" id="tradingview-link" target="_blank">
                            <i class="fas fa-external-link-alt"></i> TradingView
                        </a>
                        <button class="btn btn-success" onclick="dashboard.startWebSocket()">
                            <i class="fas fa-play"></i> Start Live
                        </button>
                        <button class="btn btn-danger" onclick="dashboard.stopWebSocket()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                    <div class="price-display" id="current-price">$0.00</div>
                </div>
            </div>

            <div class="content-area">
                <!-- Bids Panel -->
                <div class="order-panel">
                    <div class="panel-header">
                        <div class="panel-title bid">
                            <i class="fas fa-arrow-down"></i> Large BID Limits
                        </div>
                        <div class="controls">
                            <button class="btn btn-outline" onclick="dashboard.toggleClusterView('bids')">
                                <i class="fas fa-layer-group"></i> Cluster View
                            </button>
                        </div>
                    </div>
                    <div class="panel-content" id="bids-list">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="update-info" id="bids-update-info"></div>
                </div>

                <!-- Asks Panel -->
                <div class="order-panel">
                    <div class="panel-header">
                        <div class="panel-title ask">
                            <i class="fas fa-arrow-up"></i> Large ASK Limits
                        </div>
                        <div class="controls">
                            <button class="btn btn-outline" onclick="dashboard.toggleClusterView('asks')">
                                <i class="fas fa-layer-group"></i> Cluster View
                            </button>
                        </div>
                    </div>
                    <div class="panel-content" id="asks-list">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="update-info" id="asks-update-info"></div>
                </div>

                <!-- Info Panel -->
                <div class="info-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-info-circle"></i> Market Info
                        </div>
                    </div>
                    <div class="info-content">
                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-chart-bar"></i> Current Stats
                            </div>
                            <div class="info-item">
                                <span class="info-label">Current Price:</span>
                                <span class="info-value" id="info-price">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">24h Change:</span>
                                <span class="info-value" id="info-change">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">24h Volume:</span>
                                <span class="info-value" id="info-volume">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Large Bids/Asks:</span>
                                <span class="info-value" id="info-ratio">-</span>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-filter"></i> Active Filters
                            </div>
                            <div class="settings-panel">
                                <div class="setting-item">
                                    <label class="setting-label">Min Volume</label>
                                    <input type="number" class="setting-control" id="min-volume" value="15000" min="0">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Max Distance: <span id="distance-value">3.0</span>%</label>
                                    <input type="range" class="setting-control" id="max-distance" min="0.5" max="10" step="0.1" value="3.0">
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">Quick Volume Filters</label>
                                    <div class="quick-filters">
                                        <button class="btn btn-sm btn-outline" onclick="dashboard.setQuickVolumeFilter(10000)">10K</button>
                                        <button class="btn btn-sm btn-outline" onclick="dashboard.setQuickVolumeFilter(50000)">50K</button>
                                        <button class="btn btn-sm btn-outline" onclick="dashboard.setQuickVolumeFilter(100000)">100K</button>
                                    </div>
                                </div>
                                <button class="btn" onclick="dashboard.applyFilters()" style="width: 100%;">
                                    <i class="fas fa-sync-alt"></i> Apply Filters
                                </button>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-history"></i> Session Info
                            </div>
                            <div class="info-item">
                                <span class="info-label">Last Update:</span>
                                <span class="info-value" id="info-update-time">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Updates Count:</span>
                                <span class="info-value" id="info-update-count">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Connection:</span>
                                <span class="info-value" id="info-connection">Disconnected</span>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-section-title">
                                <i class="fas fa-fire"></i> Order Book Heatmap
                            </div>
                            <div class="heatmap-container" id="heatmap"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Advanced Binance Dashboard with Smart Notifications
        class AdvancedBinanceDashboard {
            constructor() {
                this.currentSymbol = 'BTCUSDT';
                this.bids = [];
                this.asks = [];
                this.largeBids = [];
                this.largeAsks = [];
                this.filteredBids = [];
                this.filteredAsks = [];
                this.currentPrice = 0;
                this.isConnected = false;
                this.leaders = [];
                this.validSymbols = new Set();
                this.updateCount = 0;
                this.lastUpdateTime = Date.now();
                this.ws = null;
                this.history = [];
                this.clusterView = {
                    bids: false,
                    asks: false
                };
                this.leadersUpdateInterval = null;
                
                // Smart Notification System
                this.notificationHistory = [];
                this.lastNotificationTime = 0;
                this.alertedOrders = new Set();
                
                // Оптимальные настройки для внутридневной торговли
                this.settings = {
                    autoRefresh: true,
                    refreshInterval: 10000,
                    soundAlerts: false,
                    theme: 'dark',
                    volumeThreshold: 3.0,
                    showVolumeBars: true,
                    orderbookDepth: 500,
                    priceFormat: 'auto',
                    alertThreshold: 50000,
                    priceAlertThreshold: 2,
                    desktopNotifications: false,
                    enableNotifications: true,
                    notificationCooldown: 5,
                    massiveOnly: false
                };

                // Увеличиваем дистанцию для внутридневной торговли (не скальпинг)
                this.filters = {
                    minVolume: 15000, // Повышаем минимальный объем
                    maxDistancePercent: 3.0 // Увеличиваем дистанцию до 3%
                };

                this.setupEventListeners();
                this.loadSettings();
                this.loadValidSymbols().then(() => {
                    this.loadLeaders();
                    this.startOrderBookUpdates();
                    this.updateTradingViewLink(this.currentSymbol);
                });

                this.initHeatmap();
            }

            setupEventListeners() {
                // Filter controls
                document.getElementById('max-distance').addEventListener('input', (e) => {
                    document.getElementById('distance-value').textContent = e.target.value;
                    this.filters.maxDistancePercent = parseFloat(e.target.value);
                });

                document.getElementById('min-volume').addEventListener('change', (e) => {
                    this.filters.minVolume = parseFloat(e.target.value) || 0;
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 's':
                                e.preventDefault();
                                this.showSymbolSelector();
                                break;
                            case 't':
                                e.preventDefault();
                                toggleTheme();
                                break;
                            case 'e':
                                e.preventDefault();
                                openModal('export-modal');
                                break;
                            case ',':
                                e.preventDefault();
                                openModal('settings-modal');
                                break;
                        }
                    }
                });
            }

            initHeatmap() {
                const heatmap = document.getElementById('heatmap');
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'heatmap-bar';
                    bar.style.left = `${i * 5}%`;
                    bar.style.width = '4.5%';
                    bar.style.height = '0%';
                    bar.style.backgroundColor = `rgba(41, 98, 255, ${Math.random() * 0.7})`;
                    bar.title = `Уровень ${i+1}: 0%`;
                    heatmap.appendChild(bar);
                }
            }

            updateHeatmap() {
                const heatmap = document.getElementById('heatmap');
                const bars = heatmap.querySelectorAll('.heatmap-bar');
                
                bars.forEach((bar, i) => {
                    const height = Math.random() * 80 + 10;
                    bar.style.height = `${height}%`;
                    bar.title = `Уровень ${i+1}: ${height.toFixed(1)}%`;
                    
                    if (height > 60) {
                        bar.style.backgroundColor = 'rgba(255, 91, 90, 0.8)';
                    } else if (height > 30) {
                        bar.style.backgroundColor = 'rgba(255, 167, 38, 0.7)';
                    } else {
                        bar.style.backgroundColor = 'rgba(0, 177, 93, 0.6)';
                    }
                });
            }

            // Smart Notification System
            showSmartNotification(title, message, type = 'info') {
                if (!this.settings.enableNotifications) return;
                
                const now = Date.now();
                const cooldownMs = this.settings.notificationCooldown * 60 * 1000;
                
                if (now - this.lastNotificationTime < cooldownMs) {
                    return;
                }
                
                const recentSimilar = this.notificationHistory.some(notif => 
                    notif.message === message && 
                    (now - notif.timestamp) < cooldownMs
                );
                
                if (recentSimilar) {
                    return;
                }
                
                this.showNotification(title, message, type);
                
                this.notificationHistory.push({
                    title,
                    message,
                    type,
                    timestamp: now
                });
                
                this.lastNotificationTime = now;
                
                if (this.notificationHistory.length > 50) {
                    this.notificationHistory.shift();
                }
            }

            checkAlerts() {
                if (!this.settings.enableNotifications) return;
                
                const now = Date.now();
                const cooldownMs = this.settings.notificationCooldown * 60 * 1000;
                
                const threshold = this.settings.massiveOnly ? 
                    this.settings.alertThreshold * 10 : 
                    this.settings.alertThreshold;
                
                const veryLargeBids = this.largeBids.filter(bid => bid.volume >= threshold);
                const veryLargeAsks = this.largeAsks.filter(ask => ask.volume >= threshold);
                
                veryLargeBids.forEach(bid => {
                    const orderId = `bid_${bid.price}_${bid.volume}`;
                    if (!this.alertedOrders.has(orderId) && (now - this.lastNotificationTime) >= cooldownMs) {
                        this.showSmartNotification(
                            '🚨 Large BID Detected',
                            `Price: $${this.formatPrice(bid.price)}\nVolume: ${this.formatNumber(bid.volume)}`,
                            'success'
                        );
                        this.alertedOrders.add(orderId);
                    }
                });
                
                veryLargeAsks.forEach(ask => {
                    const orderId = `ask_${ask.price}_${ask.volume}`;
                    if (!this.alertedOrders.has(orderId) && (now - this.lastNotificationTime) >= cooldownMs) {
                        this.showSmartNotification(
                            '🚨 Large ASK Detected',
                            `Price: $${this.formatPrice(ask.price)}\nVolume: ${this.formatNumber(ask.volume)}`,
                            'warning'
                        );
                        this.alertedOrders.add(orderId);
                    }
                });
                
                // Clean up old alerted orders
                const oneHourAgo = now - (60 * 60 * 1000);
                this.alertedOrders.forEach(orderId => {
                    if (Math.random() < 0.1) {
                        this.alertedOrders.delete(orderId);
                    }
                });
            }

            showNotification(title, message, type = 'info') {
                const notification = document.getElementById('notification');
                const titleElement = document.getElementById('notification-title');
                const messageElement = document.getElementById('notification-message');
                const iconElement = document.getElementById('notification-icon');
                
                titleElement.textContent = title;
                messageElement.textContent = message;
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                iconElement.className = `fas ${icons[type] || icons.info}`;
                
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 8000);
                
                if (this.settings.desktopNotifications && Notification.permission === 'granted') {
                    new Notification(title, {
                        body: message,
                        icon: '/favicon.ico'
                    });
                }
            }

            async fetchOrderBook(symbol, limit = null) {
                try {
                    const depth = limit || this.settings.orderbookDepth;
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000);
                    
                    const response = await fetch(`https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=${depth}`, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.bids || !data.asks) {
                        throw new Error('Invalid order book data structure');
                    }
                    
                    this.bids = data.bids.map(bid => ({
                        price: parseFloat(bid[0]),
                        volume: parseFloat(bid[1])
                    }));
                    
                    this.asks = data.asks.map(ask => ({
                        price: parseFloat(ask[0]),
                        volume: parseFloat(ask[1])
                    }));
                    
                    this.calculateCurrentPrice();
                    this.detectLargeOrders();
                    this.applyFilters();
                    this.updateUI();
                    this.updateHeatmap();
                    
                    this.checkAlerts();
                    
                    this.history.push({
                        timestamp: Date.now(),
                        symbol: this.currentSymbol,
                        bids: this.bids,
                        asks: this.asks,
                        largeBids: this.largeBids,
                        largeAsks: this.largeAsks
                    });
                    
                    if (this.history.length > 1000) {
                        this.history.shift();
                    }
                    
                } catch (error) {
                    console.error('Error fetching order book:', error);
                    this.handleOrderBookError(error, symbol);
                }
            }

            detectLargeOrders() {
                if (this.bids.length === 0 || this.asks.length === 0) return;
                
                const allVolumes = [
                    ...this.bids.map(b => b.volume),
                    ...this.asks.map(a => a.volume)
                ];
                
                const sortedVolumes = [...allVolumes].sort((a, b) => a - b);
                const medianVolume = sortedVolumes[Math.floor(sortedVolumes.length / 2)];
                const p75Volume = sortedVolumes[Math.floor(sortedVolumes.length * 0.75)];
                const p90Volume = sortedVolumes[Math.floor(sortedVolumes.length * 0.90)];
                
                let largeThreshold;
                if (p90Volume > medianVolume * 10) {
                    largeThreshold = p90Volume;
                } else {
                    largeThreshold = p75Volume * this.settings.volumeThreshold;
                }
                
                largeThreshold = Math.max(largeThreshold, 5000);
                
                this.largeBids = this.bids
                    .filter(bid => bid.volume >= largeThreshold)
                    .sort((a, b) => b.price - a.price);
                
                this.largeAsks = this.asks
                    .filter(ask => ask.volume >= largeThreshold)
                    .sort((a, b) => a.price - b.price);
            }

            applyFilters() {
                this.filteredBids = this.largeBids.filter(bid => {
                    const distance = ((this.currentPrice - bid.price) / this.currentPrice * 100);
                    return bid.volume >= this.filters.minVolume && 
                           distance <= this.filters.maxDistancePercent;
                });
                
                this.filteredAsks = this.largeAsks.filter(ask => {
                    const distance = ((ask.price - this.currentPrice) / this.currentPrice * 100);
                    return ask.volume >= this.filters.minVolume && 
                           distance <= this.filters.maxDistancePercent;
                });
            }

            calculateCurrentPrice() {
                if (this.bids.length > 0 && this.asks.length > 0) {
                    const bestBid = this.bids[0].price;
                    const bestAsk = this.asks[0].price;
                    this.currentPrice = (bestBid + bestAsk) / 2;
                }
            }

            updateUI() {
                this.updateCount++;
                this.lastUpdateTime = Date.now();
                
                const priceDisplay = this.formatPrice(this.currentPrice);
                document.getElementById('current-price').textContent = `$${priceDisplay}`;
                document.getElementById('info-price').textContent = `$${priceDisplay}`;
                
                const maxVolume = Math.max(
                    ...this.filteredBids.map(b => b.volume),
                    ...this.filteredAsks.map(a => a.volume),
                    1
                );
                
                this.updateOrderList('bids', this.filteredBids, maxVolume);
                this.updateOrderList('asks', this.filteredAsks, maxVolume);
                
                this.updateStatistics();
                
                document.getElementById('info-update-time').textContent = 
                    new Date().toLocaleTimeString() + ' (' + new Date().toLocaleDateString() + ')';
                document.getElementById('info-update-count').textContent = this.updateCount;
                document.getElementById('info-connection').textContent = this.isConnected ? 'Connected' : 'Disconnected';
            }

            updateOrderList(type, orders, maxVolume, container) {
                const listElement = document.getElementById(`${type}-list`);
                const updateInfoElement = document.getElementById(`${type}-update-info`);
                
                if (this.clusterView[type]) {
                    this.renderClusterView(type, orders, listElement);
                } else {
                    this.renderOrderView(type, orders, maxVolume, listElement);
                }
                
                updateInfoElement.textContent = 
                    `Showing ${orders.length} of ${this.largeBids.length} ${type} • Update #${this.updateCount}`;
            }

            renderOrderView(type, orders, maxVolume, container) {
                container.innerHTML = '';
                
                if (orders.length === 0) {
                    container.innerHTML = '<div class="status">No large orders matching filters</div>';
                    return;
                }
                
                orders.forEach(order => {
                    const distance = type === 'bids' 
                        ? ((this.currentPrice - order.price) / this.currentPrice * 100).toFixed(2)
                        : ((order.price - this.currentPrice) / this.currentPrice * 100).toFixed(2);
                    
                    const priceDisplay = this.formatPrice(order.price);
                    const volumePercentage = (order.volume / maxVolume) * 100;
                    const isMassive = order.volume >= this.settings.alertThreshold * 5;
                    
                    const item = document.createElement('div');
                    item.className = `order-item ${type} ${isMassive ? 'massive' : ''}`;
                    item.innerHTML = `
                        <div class="order-info">
                            <div class="order-price">$${priceDisplay}</div>
                            <div class="order-meta">
                                <span>${distance}% ${type === 'bids' ? 'below' : 'above'}</span>
                                <span>Vol: ${order.volume.toLocaleString()}</span>
                            </div>
                            ${this.settings.showVolumeBars ? 
                                `<div class="volume-bar" style="width: ${volumePercentage}%"></div>` : ''}
                        </div>
                        <div class="order-volume">${this.formatNumber(order.volume)}</div>
                    `;
                    container.appendChild(item);
                });
            }

            renderClusterView(type, orders, container) {
                container.innerHTML = '';
                
                if (orders.length === 0) {
                    container.innerHTML = '<div class="status">No large orders matching filters</div>';
                    return;
                }
                
                const clusters = this.clusterOrders(orders, 5);
                
                clusters.forEach(cluster => {
                    const clusterElement = document.createElement('div');
                    clusterElement.className = 'cluster-item';
                    clusterElement.innerHTML = `
                        <div class="cluster-header">
                            <div class="cluster-price-range">$${this.formatPrice(cluster.minPrice)} - $${this.formatPrice(cluster.maxPrice)}</div>
                            <div class="cluster-volume">${this.formatNumber(cluster.totalVolume)}</div>
                        </div>
                        <div class="cluster-orders">${cluster.orders.length} orders in cluster</div>
                    `;
                    container.appendChild(clusterElement);
                });
            }

            clusterOrders(orders, numClusters) {
                if (orders.length === 0) return [];
                
                const prices = orders.map(o => o.price).sort((a, b) => a - b);
                const minPrice = prices[0];
                const maxPrice = prices[prices.length - 1];
                const range = maxPrice - minPrice;
                const clusterSize = range / numClusters;
                
                const clusters = [];
                
                for (let i = 0; i < numClusters; i++) {
                    const clusterMin = minPrice + (i * clusterSize);
                    const clusterMax = clusterMin + clusterSize;
                    
                    const clusterOrders = orders.filter(order => 
                        order.price >= clusterMin && order.price < clusterMax
                    );
                    
                    if (clusterOrders.length > 0) {
                        clusters.push({
                            minPrice: clusterMin,
                            maxPrice: clusterMax,
                            orders: clusterOrders,
                            totalVolume: clusterOrders.reduce((sum, order) => sum + order.volume, 0)
                        });
                    }
                }
                
                return clusters;
            }

            toggleClusterView(type) {
                this.clusterView[type] = !this.clusterView[type];
                this.updateUI();
            }

            updateStatistics() {
                document.getElementById('total-bids').textContent = this.filteredBids.length;
                document.getElementById('total-asks').textContent = this.filteredAsks.length;
                
                const totalBidVolume = this.filteredBids.reduce((sum, bid) => sum + bid.volume, 0);
                const totalAskVolume = this.filteredAsks.reduce((sum, ask) => sum + ask.volume, 0);
                const totalVolume = totalBidVolume + totalAskVolume;
                
                document.getElementById('total-volume').textContent = this.formatNumber(totalVolume);
                
                const ratio = totalBidVolume > 0 ? (totalAskVolume / totalBidVolume).toFixed(2) : '0.00';
                document.getElementById('bid-ask-ratio').textContent = ratio;
                document.getElementById('info-ratio').textContent = ratio;
                
                // Индикатор силы тренда
                const strength = this.filteredBids.length - this.filteredAsks.length;
                document.getElementById('trend-strength').textContent = strength > 0 ? `📈 +${strength}` : 
                    strength < 0 ? `📉 ${strength}` : '➡️ 0';
                document.getElementById('trend-strength').style.color = strength > 0 ? 'var(--success)' : 
                    strength < 0 ? 'var(--danger)' : 'var(--text-secondary)';
                
                // Индикатор настроения рынка
                const sentiment = totalBidVolume > totalAskVolume * 1.5 ? '😊' : 
                                totalAskVolume > totalBidVolume * 1.5 ? '😟' : '😐';
                document.getElementById('market-sentiment').textContent = sentiment;
            }

            formatPrice(price) {
                switch(this.settings.priceFormat) {
                    case 'fixed2': return price.toFixed(2);
                    case 'fixed4': return price.toFixed(4);
                    case 'fixed6': return price.toFixed(6);
                    default: return price > 1 ? price.toFixed(2) : price.toFixed(6);
                }
            }

            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(2) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(2) + 'K';
                }
                return num.toFixed(2);
            }

            updateTradingViewLink(symbol) {
                const tvLink = document.getElementById('tradingview-link');
                const tvSymbol = `BINANCE:${symbol}.P`; // .P для perpetual futures
                tvLink.href = `https://www.tradingview.com/chart/?symbol=${tvSymbol}`;
            }

            startOrderBookUpdates() {
                this.fetchOrderBook(this.currentSymbol);
                if (this.settings.autoRefresh) {
                    this.intervalId = setInterval(() => {
                        this.fetchOrderBook(this.currentSymbol);
                    }, this.settings.refreshInterval);
                }
            }

            startWebSocket() {
                this.isConnected = true;
                this.updateUI();
                this.showSmartNotification(
                    'WebSocket Started',
                    'Real-time data connection established',
                    'success'
                );
            }

            stopWebSocket() {
                this.isConnected = false;
                this.updateUI();
                this.showSmartNotification(
                    'WebSocket Stopped',
                    'Real-time data connection stopped',
                    'warning'
                );
            }

            async loadValidSymbols() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/exchangeInfo');
                    const data = await response.json();
                    data.symbols.forEach(symbol => {
                        if (symbol.quoteAsset === 'USDT' && symbol.status === 'TRADING') {
                            this.validSymbols.add(symbol.symbol);
                        }
                    });
                } catch (error) {
                    const popularSymbols = ['BTCUSDT', 'ETHUSDT', 'ADAUSDT', 'DOTUSDT', 'LINKUSDT', 'MATICUSDT', 'AVAXUSDT', 'ATOMUSDT', 'XRPUSDT', 'SOLUSDT'];
                    popularSymbols.forEach(sym => this.validSymbols.add(sym));
                }
            }

            async loadLeaders() {
                try {
                    // Используем фьючерсный API Binance для бессрочных контрактов
                    const response = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
                    const data = await response.json();
                    
                    console.log('Total symbols from futures API:', data.length);
                    
                    this.leaders = data
                        .filter(ticker => {
                            // Фильтруем только USDT пары и проверяем что это бессрочные
                            const isUSDT = ticker.symbol.endsWith('USDT');
                            const hasVolume = parseFloat(ticker.quoteVolume) > 1000000; // Минимальный объем 1M USDT
                            const hasPrice = parseFloat(ticker.lastPrice) > 0;
                            const hasChange = Math.abs(parseFloat(ticker.priceChangePercent)) > 0;
                            
                            return isUSDT && hasVolume && hasPrice && hasChange;
                        })
                        .map(ticker => ({
                            symbol: ticker.symbol,
                            price: parseFloat(ticker.lastPrice),
                            change: parseFloat(ticker.priceChangePercent),
                            volume: parseFloat(ticker.volume),
                            quoteVolume: parseFloat(ticker.quoteVolume), // Объем в USDT
                            highPrice: parseFloat(ticker.highPrice),
                            lowPrice: parseFloat(ticker.lowPrice)
                        }))
                        .sort((a, b) => b.change - a.change)
                        .slice(0, 30);
                    
                    console.log('Filtered leaders:', this.leaders.length);
                    console.log('Top 5 leaders:', this.leaders.slice(0, 5));
                    
                    this.renderLeaders();
                    
                    // Автообновление лидеров каждые 2 минуты
                    if (this.leadersUpdateInterval) {
                        clearInterval(this.leadersUpdateInterval);
                    }
                    this.leadersUpdateInterval = setInterval(() => {
                        this.loadLeaders();
                    }, 120000); // 2 минуты
                    
                } catch (error) {
                    console.error('Error loading futures leaders:', error);
                    // Fallback to spot API if futures fails
                    try {
                        const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                        const data = await response.json();
                        
                        this.leaders = data
                            .filter(ticker => {
                                return this.validSymbols.has(ticker.symbol) && 
                                       ticker.symbol.endsWith('USDT') &&
                                       parseFloat(ticker.lastPrice) > 0 &&
                                       parseFloat(ticker.quoteVolume) > 1000000;
                            })
                            .map(ticker => ({
                                symbol: ticker.symbol,
                                price: parseFloat(ticker.lastPrice),
                                change: parseFloat(ticker.priceChangePercent),
                                volume: parseFloat(ticker.volume),
                                quoteVolume: parseFloat(ticker.quoteVolume)
                            }))
                            .sort((a, b) => b.change - a.change)
                            .slice(0, 30);
                        
                        this.renderLeaders();
                    } catch (fallbackError) {
                        console.error('Fallback also failed:', fallbackError);
                        this.useRealisticLeaders();
                    }
                }
            }

            useRealisticLeaders() {
                // Расширяем до 30 монет
                this.leaders = [
                    { symbol: 'BTCUSDT', price: 68500, change: 2.5, volume: 50000, quoteVolume: 3425000000 },
                    { symbol: 'ETHUSDT', price: 3500, change: 1.8, volume: 25000, quoteVolume: 87500000 },
                    { symbol: 'SOLUSDT', price: 185, change: 5.2, volume: 15000, quoteVolume: 2775000 },
                    { symbol: 'ADAUSDT', price: 0.45, change: 3.1, volume: 8000, quoteVolume: 3600 },
                    { symbol: 'DOTUSDT', price: 7.2, change: 2.8, volume: 6000, quoteVolume: 43200 },
                    { symbol: 'LINKUSDT', price: 18.5, change: 4.5, volume: 4000, quoteVolume: 74000 },
                    { symbol: 'MATICUSDT', price: 0.85, change: 1.2, volume: 7000, quoteVolume: 5950 },
                    { symbol: 'AVAXUSDT', price: 35.6, change: 6.1, volume: 3000, quoteVolume: 106800 },
                    { symbol: 'ATOMUSDT', price: 12.2, change: 2.3, volume: 2000, quoteVolume: 24400 },
                    { symbol: 'XRPUSDT', price: 0.62, change: 0.8, volume: 12000, quoteVolume: 7440 },
                    { symbol: 'DOGEUSDT', price: 0.15, change: 3.5, volume: 9000, quoteVolume: 1350 },
                    { symbol: 'LTCUSDT', price: 85, change: 1.5, volume: 5000, quoteVolume: 425000 },
                    { symbol: 'BCHUSDT', price: 450, change: 2.1, volume: 3000, quoteVolume: 1350000 },
                    { symbol: 'ETCUSDT', price: 35, change: 1.8, volume: 2000, quoteVolume: 70000 },
                    { symbol: 'XLMUSDT', price: 0.12, change: 2.5, volume: 4000, quoteVolume: 480 }
                ].filter(item => this.validSymbols.has(item.symbol)).slice(0, 30);
                
                this.renderLeaders();
            }

            renderLeaders() {
                const container = document.getElementById('leaders-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.leaders.forEach((leader) => {
                    const item = document.createElement('div');
                    item.className = `symbol-item ${leader.symbol === this.currentSymbol ? 'active' : ''}`;
                    item.innerHTML = `
                        <div>
                            <div class="symbol-name">${leader.symbol}</div>
                            <div class="symbol-price">$${this.formatPrice(leader.price)}</div>
                            <div class="volume-info">Vol: $${this.formatNumber(leader.quoteVolume)}</div>
                        </div>
                        <div class="symbol-change ${leader.change >= 0 ? 'positive' : 'negative'}">
                            ${leader.change >= 0 ? '+' : ''}${leader.change.toFixed(2)}%
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.switchSymbol(leader.symbol);
                    });
                    
                    container.appendChild(item);
                });
            }

            switchSymbol(symbol) {
                if (this.currentSymbol === symbol) return;
                
                // Сбрасываем данные перед загрузкой новых
                this.bids = [];
                this.asks = [];
                this.largeBids = [];
                this.largeAsks = [];
                this.filteredBids = [];
                this.filteredAsks = [];
                this.currentPrice = 0;
                
                // Показываем индикатор загрузки
                document.querySelectorAll('.panel-content').forEach(panel => {
                    panel.innerHTML = '<div class="loading-spinner"></div>';
                });
                
                this.currentSymbol = symbol;
                document.getElementById('current-symbol').textContent = symbol;
                this.updateTradingViewLink(symbol);
                
                // Обновляем выбранный option в select
                const select = document.getElementById('symbol-selector');
                if (select) {
                    select.value = symbol;
                }
                
                this.renderLeaders();
                this.fetchOrderBook(symbol); // Загружаем новые данные
                
                this.showSmartNotification(
                    'Symbol Changed',
                    `Now analyzing: ${symbol}`,
                    'info'
                );
            }

            // Новый метод для быстрых фильтров объема
            setQuickVolumeFilter(volume) {
                document.getElementById('min-volume').value = volume;
                this.filters.minVolume = volume;
                this.applyFilters();
                this.updateUI();
                
                this.showSmartNotification(
                    'Filter Updated',
                    `Minimum volume set: ${this.formatNumber(volume)}`,
                    'info'
                );
            }

            handleOrderBookError(error, symbol) {
                if (error.name === 'AbortError') {
                    this.showSmartNotification(
                        'Request Timeout',
                        'Order book request timed out, retrying...',
                        'warning'
                    );
                } else if (error.message.includes('Invalid symbol')) {
                    this.showSmartNotification(
                        'Invalid Symbol',
                        `Symbol ${symbol} not found on Binance`,
                        'error'
                    );
                } else {
                    this.showSmartNotification(
                        'Network Error',
                        'Using mock data due to network issues',
                        'warning'
                    );
                    this.useMockData();
                }
            }

            useMockData() {
                this.currentPrice = 0.6057;
                
                this.largeBids = [
                    { price: 0.6054, volume: 11125.20 },
                    { price: 0.6053, volume: 7545.40 },
                    { price: 0.6047, volume: 10401.60 },
                    { price: 0.6046, volume: 11235.00 },
                    { price: 0.6004, volume: 28761.30 },
                    { price: 0.5988, volume: 12626.10 }
                ];
                
                this.largeAsks = [
                    { price: 0.6061, volume: 8536.60 },
                    { price: 0.6067, volume: 8148.70 },
                    { price: 0.6073, volume: 11232.50 },
                    { price: 0.6112, volume: 21868.20 },
                    { price: 0.6113, volume: 21749.60 },
                    { price: 0.6142, volume: 21274.60 }
                ];
                
                this.applyFilters();
                this.updateUI();
            }

            loadSettings() {
                const saved = localStorage.getItem('binance-dashboard-settings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                    this.applySettings();
                }
                
                if (this.settings.desktopNotifications && 'Notification' in window) {
                    Notification.requestPermission();
                }
            }

            saveSettings() {
                localStorage.setItem('binance-dashboard-settings', JSON.stringify(this.settings));
                this.showSmartNotification(
                    'Settings Saved',
                    'Your preferences have been saved successfully',
                    'success'
                );
            }

            applySettings() {
                document.body.setAttribute('data-theme', this.settings.theme);
                
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                }
                
                if (this.settings.autoRefresh) {
                    this.intervalId = setInterval(() => {
                        this.fetchOrderBook(this.currentSymbol);
                    }, this.settings.refreshInterval);
                }
                
                if (this.settings.desktopNotifications && 'Notification' in window) {
                    Notification.requestPermission();
                }
                
                this.updateUI();
            }

            showSymbolSelector() {
                this.showSmartNotification(
                    'Symbol Selector',
                    'Symbol selection dialog would open here',
                    'info'
                );
            }
        }

        // Global functions for UI interactions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 
                           currentTheme === 'light' ? 'high-contrast' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            dashboard.settings.theme = newTheme;
            dashboard.saveSettings();
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function saveSettings() {
            dashboard.settings.refreshInterval = document.getElementById('refresh-interval').value * 1000;
            dashboard.settings.orderbookDepth = document.getElementById('orderbook-depth').value;
            dashboard.settings.volumeThreshold = parseFloat(document.getElementById('volume-threshold').value);
            dashboard.settings.soundAlerts = document.getElementById('sound-alerts').checked;
            dashboard.settings.theme = document.getElementById('theme-selector').value;
            dashboard.settings.showVolumeBars = document.getElementById('show-volume-bars').checked;
            dashboard.settings.priceFormat = document.getElementById('price-format').value;
            dashboard.settings.alertThreshold = parseFloat(document.getElementById('alert-threshold').value);
            dashboard.settings.desktopNotifications = document.getElementById('desktop-notifications').checked;
            dashboard.settings.enableNotifications = document.getElementById('enable-notifications').checked;
            dashboard.settings.notificationCooldown = parseFloat(document.getElementById('notification-cooldown').value);
            dashboard.settings.massiveOnly = document.getElementById('massive-only').checked;
            
            dashboard.saveSettings();
            dashboard.applySettings();
            closeModal('settings-modal');
        }

        function exportData() {
            const format = document.getElementById('export-format').value;
            const include = Array.from(document.getElementById('export-include').selectedOptions).map(o => o.value);
            const range = document.getElementById('export-range').value;
            
            let data = {
                symbol: dashboard.currentSymbol,
                timestamp: new Date().toISOString(),
                currentPrice: dashboard.currentPrice,
                filters: dashboard.filters,
                settings: dashboard.settings
            };
            
            if (include.includes('large-orders')) {
                data.largeBids = dashboard.filteredBids;
                data.largeAsks = dashboard.filteredAsks;
            }
            
            if (include.includes('orderbook')) {
                data.bids = dashboard.bids;
                data.asks = dashboard.asks;
            }
            
            if (include.includes('market-data')) {
                data.marketData = {
                    leaders: dashboard.leaders,
                    updateCount: dashboard.updateCount
                };
            }
            
            let blob, filename;
            
            if (format === 'json') {
                blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                filename = `orderbook_${dashboard.currentSymbol}_${Date.now()}.json`;
            } else if (format === 'csv') {
                let csv = 'Type,Price,Volume,Distance\n';
                dashboard.filteredBids.forEach(bid => {
                    const distance = ((dashboard.currentPrice - bid.price) / dashboard.currentPrice * 100).toFixed(2);
                    csv += `BID,${bid.price},${bid.volume},${distance}\n`;
                });
                dashboard.filteredAsks.forEach(ask => {
                    const distance = ((ask.price - dashboard.currentPrice) / dashboard.currentPrice * 100).toFixed(2);
                    csv += `ASK,${ask.price},${ask.volume},${distance}\n`;
                });
                blob = new Blob([csv], { type: 'text/csv' });
                filename = `orderbook_${dashboard.currentSymbol}_${Date.now()}.csv`;
            } else {
                blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                filename = `orderbook_${dashboard.currentSymbol}_${Date.now()}.json`;
            }
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            dashboard.showSmartNotification(
                'Data Exported',
                `Order book data exported as ${format.toUpperCase()}`,
                'success'
            );
            closeModal('export-modal');
        }

        // Initialize dashboard when page loads
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new AdvancedBinanceDashboard();
            
            // Initialize settings form values
            document.getElementById('refresh-interval').value = dashboard.settings.refreshInterval / 1000;
            document.getElementById('orderbook-depth').value = dashboard.settings.orderbookDepth;
            document.getElementById('volume-threshold').value = dashboard.settings.volumeThreshold;
            document.getElementById('volume-threshold-value').textContent = dashboard.settings.volumeThreshold + 'x';
            document.getElementById('sound-alerts').checked = dashboard.settings.soundAlerts;
            document.getElementById('theme-selector').value = dashboard.settings.theme;
            document.getElementById('show-volume-bars').checked = dashboard.settings.showVolumeBars;
            document.getElementById('price-format').value = dashboard.settings.priceFormat;
            document.getElementById('alert-threshold').value = dashboard.settings.alertThreshold;
            document.getElementById('desktop-notifications').checked = dashboard.settings.desktopNotifications;
            document.getElementById('enable-notifications').checked = dashboard.settings.enableNotifications;
            document.getElementById('notification-cooldown').value = dashboard.settings.notificationCooldown;
            document.getElementById('massive-only').checked = dashboard.settings.massiveOnly;
            
            // Update volume threshold display when slider changes
            document.getElementById('volume-threshold').addEventListener('input', (e) => {
                document.getElementById('volume-threshold-value').textContent = e.target.value + 'x';
            });
        });
    </script>
</body>
</html>